# Архитектура взаимодействия с постами: лайки и комментарии

## Обзор

Реализована архитектура согласно техническому заданию с отдельными моделями для лайков и комментариев, связанными через ID с пользователями и постами.

## Модели данных

### 1. Модель лайков (likeModel.js)
```javascript
{
  user: ObjectId,     // Ссылка на пользователя
  post: ObjectId,     // Ссылка на пост
  timestamps: true    // createdAt, updatedAt
}
```
- Уникальный индекс по полям `user` и `post` - один пользователь может лайкнуть пост только один раз

### 2. Модель комментариев (commentModel.js)
```javascript
{
  author: ObjectId,   // Ссылка на автора комментария
  post: ObjectId,     // Ссылка на пост
  text: String,       // Текст комментария (макс. 2200 символов)
  likesCount: Number, // Количество лайков комментария (по умолчанию 0)
  timestamps: true    // createdAt, updatedAt
}
```
- Индекс по полям `post` и `createdAt` для быстрого поиска комментариев к посту

### 3. Обновленная модель постов (postModel.js)
```javascript
{
  author: ObjectId,     // Автор поста
  image: String,        // Изображение в base64
  caption: String,      // Подпись к посту
  likesCount: Number,   // Количество лайков (по умолчанию 0)
  commentsCount: Number,// Количество комментариев (по умолчанию 0)
  createdAt: Date      // Дата создания
}
```

## API Endpoints

### Лайки (likeRoutes.js)
- `POST /api/likes/:postId` - Лайк/дизлайк поста (требует авторизации)
- `GET /api/likes/:postId` - Получение списка лайков поста

### Комментарии (commentRoutes.js)
- `POST /api/comments/:postId` - Создание комментария (требует авторизации)
- `GET /api/comments/:postId` - Получение комментариев поста
- `PUT /api/comments/:commentId` - Обновление комментария (требует авторизации)
- `DELETE /api/comments/:commentId` - Удаление комментария (требует авторизации)

### Посты (postRoutes.js)
- `GET /api/posts` - Получение всех постов с информацией о лайках и комментариях
- `GET /api/posts/user/:userId` - Получение постов пользователя
- `GET /api/posts/:postId` - Получение конкретного поста
- Остальные CRUD операции для постов

## Контроллеры

### 1. Контроллер лайков (likeController.js)
- `toggleLike()` - Добавление/удаление лайка с проверкой существования
- `getPostLikes()` - Получение списка пользователей, лайкнувших пост
- Автоматическое обновление счетчика лайков в посте
- Создание/удаление уведомлений о лайках

### 2. Контроллер комментариев (commentController.js)
- `createComment()` - Создание комментария с валидацией
- `getPostComments()` - Получение комментариев с пагинацией
- `updateComment()` - Обновление комментария (только автором)
- `deleteComment()` - Удаление комментария (только автором)
- Автоматическое обновление счетчика комментариев в посте
- Создание/удаление уведомлений о комментариях

### 3. Обновленный контроллер постов (postController.js)
- Получение постов с информацией о лайках и комментариях
- Проверка статуса лайка для текущего пользователя
- Получение последних комментариев для превью
- Каскадное удаление связанных лайков и комментариев при удалении поста

## Фронтенд интеграция

### Компоненты
- `PostCard` - Отображение поста с лайками и комментариями
- `PostViewModal` - Модальное окно просмотра поста
- `FeedPage` - Лента постов
- `ProfilePage` - Профиль пользователя

### Особенности реализации
- Оптимистичные обновления для лучшего UX
- Откат изменений при ошибках сервера
- Использование новых полей `isLiked`, `likesCount`, `commentsCount`
- Правильная обработка авторизации для действий с лайками/комментариями

## Преимущества новой архитектуры

1. **Масштабируемость** - Отдельные коллекции позволяют эффективно работать с большим количеством лайков и комментариев
2. **Производительность** - Индексы обеспечивают быстрый поиск и сортировку
3. **Гибкость** - Легко добавлять новые функции (лайки комментариев, ответы на комментарии)
4. **Целостность данных** - Каскадное удаление и валидация обеспечивают консистентность
5. **Аналитика** - Возможность детального анализа взаимодействий пользователей

## Миграция данных

При переходе на новую архитектуру необходимо:
1. Создать новые коллекции `likes` и `comments`
2. Мигрировать данные из встроенных массивов в отдельные документы
3. Обновить счетчики в существующих постах
4. Обновить фронтенд для работы с новыми API

## Безопасность

- Все операции с лайками и комментариями требуют авторизации
- Пользователи могут редактировать/удалять только свои комментарии
- Валидация входных данных на уровне модели и контроллера
- Защита от дублирования лайков через уникальные индексы 